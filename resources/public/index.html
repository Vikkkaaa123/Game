<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ü–æ–±–µ–≥ –∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏</title>
		<style>
			:root {
				--bg-dark: #0f172a;
				--bg-panel: #1e293b;
				--border: #334155;
				--text: #e2e8f0;
				--text-secondary: #94a3b8;
				--accent: #3b82f6;
				--success: #10b981;
				--error: #ef4444;
				--warning: #f59e0b;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
					sans-serif;
				background: var(--bg-dark);
				color: var(--text);
				line-height: 1.5;
				padding: 20px;
				height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.container {
				width: 100%;
				max-width: 1200px;
				height: 90vh;
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			.header {
				text-align: center;
				padding-bottom: 20px;
				border-bottom: 1px solid var(--border);
			}

			.game-title {
				color: var(--accent);
				font-size: 2rem;
				font-weight: 700;
				margin-bottom: 8px;
			}

			.subtitle {
				color: var(--text-secondary);
				font-size: 1rem;
			}

			.status-bar {
				display: flex;
				gap: 30px;
				padding: 12px 20px;
				background: var(--bg-panel);
				border-radius: 8px;
				border: 1px solid var(--border);
				font-size: 0.9rem;
			}

			.status-item {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.status-icon {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				display: inline-block;
			}

			.status-icon.connected {
				background: var(--success);
				box-shadow: 0 0 8px var(--success);
			}

			.status-icon.disconnected {
				background: var(--error);
			}

			.status-icon.connecting {
				background: var(--warning);
				animation: pulse 1.5s infinite;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			.game-area {
				flex: 1;
				display: flex;
				gap: 20px;
				min-height: 0;
			}

			.output-panel {
				flex: 3;
				background: var(--bg-panel);
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 20px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				gap: 10px;
			}

			.sidebar {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 20px;
				min-width: 250px;
			}

			.sidebar-panel {
				background: var(--bg-panel);
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 15px;
			}

			.panel-title {
				color: var(--accent);
				font-size: 1rem;
				font-weight: 600;
				margin-bottom: 10px;
				padding-bottom: 8px;
				border-bottom: 1px solid var(--border);
			}

			.commands-grid {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 8px;
				margin-top: 10px;
			}

			.command-item {
				padding: 6px 10px;
				background: rgba(59, 130, 246, 0.1);
				border: 1px solid rgba(59, 130, 246, 0.2);
				border-radius: 4px;
				font-size: 0.85rem;
			}

			.players-list,
			.inventory-list {
				display: flex;
				flex-direction: column;
				gap: 6px;
			}

			.player-item,
			.inventory-item {
				padding: 8px 10px;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 4px;
				font-size: 0.9rem;
			}

			.input-area {
				margin-top: 10px;
			}

			.input-group {
				display: flex;
				gap: 10px;
			}

			#command-input,
			#name-input {
				flex: 1;
				padding: 12px;
				background: var(--bg-panel);
				border: 1px solid var(--border);
				border-radius: 6px;
				color: var(--text);
				font-family: inherit;
				font-size: 1rem;
				outline: none;
			}

			#command-input:focus,
			#name-input:focus {
				border-color: var(--accent);
			}

			.btn {
				padding: 12px 24px;
				background: var(--accent);
				color: white;
				border: none;
				border-radius: 6px;
				font-family: inherit;
				font-size: 1rem;
				cursor: pointer;
				font-weight: 500;
				transition: background 0.2s;
			}

			.btn:hover {
				background: #2563eb;
			}

			.btn:disabled {
				background: var(--text-secondary);
				cursor: not-allowed;
			}

			.message {
				padding: 8px 0;
				animation: fadeIn 0.2s ease;
			}

			.message.system {
				color: var(--text-secondary);
			}

			.message.error {
				color: var(--error);
			}

			.message.success {
				color: var(--success);
			}

			.message.command {
				color: var(--accent);
				font-style: italic;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			.connection-status {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 6px 12px;
				border-radius: 20px;
				font-size: 0.85rem;
				background: rgba(59, 130, 246, 0.1);
				border: 1px solid rgba(59, 130, 246, 0.2);
			}

			#registration-section .input-group {
				flex-direction: column;
				align-items: stretch;
			}

			#registration-section #name-input {
				margin-bottom: 10px;
			}

			.hidden {
				display: none;
			}

			.output-panel::-webkit-scrollbar {
				width: 8px;
			}

			.output-panel::-webkit-scrollbar-track {
				background: var(--bg-panel);
			}

			.output-panel::-webkit-scrollbar-thumb {
				background: var(--border);
				border-radius: 4px;
			}

			@media (max-width: 768px) {
				.game-area {
					flex-direction: column;
				}

				.sidebar {
					min-width: auto;
				}

				.commands-grid {
					grid-template-columns: 1fr;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1 class="game-title">–ü–û–ë–ï–ì –ò–ó –õ–ê–ë–û–†–ê–¢–û–†–ò–ò</h1>
				<p class="subtitle">–ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞ Clojure</p>
				<div class="connection-status" id="connection-status">
					<span class="status-icon connecting"></span>
					<span id="status-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
				</div>
			</div>

			<div class="status-bar">
				<div class="status-item">
					<span>–ò–≥—Ä–æ–∫: <span id="player-name">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span></span>
				</div>
				<!-- <div class="status-item">
					<span>–û–Ω–ª–∞–π–Ω: <span id="online-count">0</span></span>
				</div> -->
				<div class="status-item">
					<span>–ö–æ–º–Ω–∞—Ç: <span id="rooms-count">5</span></span>
				</div>
			</div>

			<div class="game-area">
				<div class="output-panel" id="output-panel">
					<div class="message system">
						–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É "–ü–æ–±–µ–≥ –∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏"!
					</div>
					<div class="message system">
						–î–ª—è –Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É".
					</div>
				</div>

				<div class="sidebar">
					<!-- <div class="sidebar-panel">
						<div class="panel-title">–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
						<div class="players-list" id="players-list">
							<div class="player-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
						</div>
					</div> -->

					<!-- <div class="sidebar-panel">
						<div class="panel-title">–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
						<div class="inventory-list" id="inventory-list">
							<div class="inventory-item">–ü—É—Å—Ç–æ</div>
						</div>
					</div> -->

					<div class="sidebar-panel">
						<div class="panel-title">–ö–æ–º–∞–Ω–¥—ã</div>
						<div class="commands-grid">
							<div class="command-item">look</div>
							<div class="command-item">north/south</div>
							<div class="command-item">take [–ø—Ä–µ–¥–º–µ—Ç]</div>
							<div class="command-item">drop [–ø—Ä–µ–¥–º–µ—Ç]</div>
							<div class="command-item">inventory</div>
							<div class="command-item">help</div>
							<div class="command-item">say [—Ç–µ–∫—Å—Ç]</div>
							<div class="command-item">exit</div>
						</div>
					</div>
				</div>
			</div>

			<div class="input-area">
				<div id="registration-section">
					<div class="input-group">
						<input
							type="text"
							id="name-input"
							placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞"
							autocomplete="off"
						/>
						<button class="btn" id="register-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
					</div>
				</div>

				<div id="game-section" class="hidden">
					<div class="input-group">
						<input
							type="text"
							id="command-input"
							placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..."
							autocomplete="off"
						/>
						<button class="btn" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
			const CONFIG = {
				WS_URL: "ws://" + window.location.hostname + ":8080/ws",
				RECONNECT_DELAY: 3000,
				PLAYER_NAME_MAX: 20,
				PLAYER_NAME_MIN: 2,
			};

			// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
			const AppState = {
				ws: null,
				playerName: "",
				isConnected: false,
				registered: false,
				reconnectAttempts: 0,
				maxReconnectAttempts: 5,
			};

			// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
			const elements = {
				output: document.getElementById("output-panel"),
				nameInput: document.getElementById("name-input"),
				commandInput: document.getElementById("command-input"),
				registerBtn: document.getElementById("register-btn"),
				sendBtn: document.getElementById("send-btn"),
				statusIcon: document.querySelector(".status-icon"),
				statusText: document.getElementById("status-text"),
				playerNameSpan: document.getElementById("player-name"),
				onlineCount: document.getElementById("online-count"),
				roomsCount: document.getElementById("rooms-count"),
				playersList: document.getElementById("players-list"),
				inventoryList: document.getElementById("inventory-list"),
				registrationSection: document.getElementById("registration-section"),
				gameSection: document.getElementById("game-section"),
				connectionStatus: document.getElementById("connection-status"),
			};

			// ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
			function updateConnectionStatus(status, message) {
				const statusMap = {
					connecting: {
						class: "connecting",
						color: "var(--warning)",
						text: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
					},
					connected: {
						class: "connected",
						color: "var(--success)",
						text: "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ",
					},
					disconnected: {
						class: "disconnected",
						color: "var(--error)",
						text: "–û—Ç–∫–ª—é—á–µ–Ω–æ",
					},
					error: {
						class: "disconnected",
						color: "var(--error)",
						text: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è",
					},
				};

				const statusInfo = statusMap[status] || statusMap.disconnected;

				// –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
				elements.statusIcon.className = "status-icon " + statusInfo.class;
				elements.statusIcon.style.background = statusInfo.color;

				// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
				elements.statusText.textContent = message || statusInfo.text;
				elements.statusText.style.color = statusInfo.color;

				// –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–º–∫—É
				elements.connectionStatus.style.borderColor = statusInfo.color;
				elements.connectionStatus.style.background = statusInfo.color + "10";

				// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
				AppState.isConnected = status === "connected";
			}

			// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
			function logMessage(text, type = "normal") {
				const messageDiv = document.createElement("div");
				messageDiv.className = `message ${type}`;
				messageDiv.textContent = text;
				elements.output.appendChild(messageDiv);
				elements.output.scrollTop = elements.output.scrollHeight;
			}

			// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
			function connectWebSocket() {
				if (AppState.reconnectAttempts >= AppState.maxReconnectAttempts) {
					logMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É", "error");
					updateConnectionStatus("error", "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
					return;
				}

				updateConnectionStatus("connecting", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...");

				try {
					AppState.ws = new WebSocket(CONFIG.WS_URL);

					AppState.ws.onopen = function () {
						AppState.isConnected = true;
						AppState.reconnectAttempts = 0;
						updateConnectionStatus("connected", "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É");
						logMessage("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "success");

						// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
						if (AppState.registered && AppState.playerName) {
							setTimeout(() => {
								registerPlayer(AppState.playerName, true);
							}, 500);
						}
					};

					AppState.ws.onmessage = function (event) {
						try {
							const data = JSON.parse(event.data);
							handleWebSocketMessage(data);
						} catch (error) {
							logMessage("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: " + error, "error");
						}
					};

					AppState.ws.onerror = function (error) {
						logMessage("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
						updateConnectionStatus("error", "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
					};

					AppState.ws.onclose = function () {
						AppState.isConnected = false;
						updateConnectionStatus("disconnected", "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ");

						if (AppState.registered) {
							logMessage("–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "warning");
							AppState.reconnectAttempts++;

							if (AppState.reconnectAttempts < AppState.maxReconnectAttempts) {
								const delay = Math.min(
									1000 * Math.pow(2, AppState.reconnectAttempts),
									10000
								);
								logMessage(
									`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay / 1000} —Å–µ–∫...`,
									"system"
								);

								setTimeout(() => {
									connectWebSocket();
								}, delay);
							}
						}
					};
				} catch (error) {
					logMessage("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + error, "error");
					updateConnectionStatus("error", "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
				}
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
			function handleWebSocketMessage(data) {
				switch (data.type) {
					case "welcome":
						logMessage(data.message || "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!", "system");
						break;

					case "registered":
						handleRegistrationResponse(data);
						break;

					case "command-response":
						handleCommandResponse(data);
						break;

					case "chat":
						handleChatMessage(data);
						break;

					case "error":
						logMessage(data.message, "error");
						break;

					default:
						logMessage(
							"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: " + JSON.stringify(data),
							"warning"
						);
				}
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
			function handleRegistrationResponse(data) {
				if (data.error) {
					logMessage(data.message, "error");
				} else {
					AppState.registered = true;
					AppState.playerName = data.player || AppState.playerName;

					// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
					elements.playerNameSpan.textContent = AppState.playerName;
					elements.registrationSection.classList.add("hidden");
					elements.gameSection.classList.remove("hidden");
					elements.commandInput.focus();

					logMessage(
						`–ò–≥—Ä–æ–∫ "${AppState.playerName}" —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`,
						"success"
					);

					// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
					if (data.gameState) {
						updateGameState(data.gameState);
					}

					// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º look
					setTimeout(() => {
						sendGameCommand("look");
					}, 500);
				}
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É
			function handleCommandResponse(data) {
				if (data.result && data.result.message) {
					const lines = data.result.message.split("\n");
					lines.forEach((line) => {
						if (line.trim()) {
							const type = data.result.error ? "error" : "normal";
							logMessage(line, type);
						}
					});
				}

				// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
				if (data.gameState) {
					updateGameState(data.gameState);
				}
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
			function handleChatMessage(data) {
				const timestamp = new Date(
					data.timestamp || Date.now()
				).toLocaleTimeString("ru-RU", {
					hour: "2-digit",
					minute: "2-digit",
					second: "2-digit",
				});

				let message = "";
				if (data.from === AppState.playerName) {
					// –°–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
					message = `[${timestamp}] –í—ã —Å–∫–∞–∑–∞–ª–∏: ${data.message}`;
					logMessage(message, "system");
				} else {
					// –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
					message = `[${timestamp}] ${data.from}: ${data.message}`;
					logMessage(message, "normal");

					// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
					if (document.hidden) {
						showBrowserNotification(`${data.from}: ${data.message}`);
					}

					// –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
					playNotificationSound();
				}

				// –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
				if (data.gameState) {
					updateGameState(data.gameState);
				}
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
			function updateGameState(gameState) {
				if (!gameState || gameState.error) {
					return;
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
				if (gameState.room && gameState.room.players) {
					updatePlayersList(gameState.room.players);
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
				if (gameState.player && gameState.player.inventory) {
					updateInventoryList(gameState.player.inventory);
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
				if (gameState.room) {
					const playerCount = gameState.room.players
						? gameState.room.players.size
						: 0;
					elements.onlineCount.textContent = playerCount;
				}
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
			function updatePlayersList(players) {
				if (!players || !players.size) {
					elements.playersList.innerHTML =
						'<div class="player-item">–í –∫–æ–º–Ω–∞—Ç–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</div>';
					return;
				}

				const playersArray = Array.from(players).filter(
					(p) => p !== AppState.playerName
				);

				if (playersArray.length === 0) {
					elements.playersList.innerHTML =
						'<div class="player-item">–í—ã –æ–¥–∏–Ω –≤ –∫–æ–º–Ω–∞—Ç–µ</div>';
					return;
				}

				elements.playersList.innerHTML = playersArray
					.map((player) => `<div class="player-item">${player}</div>`)
					.join("");
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - –¥–ª—è –º–∞—Å—Å–∏–≤–∞)
			function updateInventoryList(inventory) {
				console.log("üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–í–ï–ù–¢–ê–†–Ø –≤—ã–∑–≤–∞–Ω–æ:", inventory);
				console.log("üìä –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:", typeof inventory);
				console.log("üìä –≠—Ç–æ –º–∞—Å—Å–∏–≤?", Array.isArray(inventory));
				console.log("üìä –≠—Ç–æ Set?", inventory instanceof Set);

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
				if (!elements.inventoryList) {
					console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç inventory-list –Ω–µ –Ω–∞–π–¥–µ–Ω!");
					elements.inventoryList = document.getElementById("inventory-list");
					console.log("üîç –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç:", elements.inventoryList);
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
				if (!inventory) {
					console.log("üì≠ inventory is null/undefined");
					elements.inventoryList.innerHTML =
						'<div class="inventory-item">–ü—É—Å—Ç–æ</div>';
					return;
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–¥–ª—è –º–∞—Å—Å–∏–≤–∞) –∏–ª–∏ —Ä–∞–∑–º–µ—Ä (–¥–ª—è Set)
				let itemCount;
				if (Array.isArray(inventory)) {
					itemCount = inventory.length;
					console.log(`üì¶ –ú–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç ${itemCount} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
				} else if (inventory instanceof Set) {
					itemCount = inventory.size;
					console.log(`üì¶ Set —Å–æ–¥–µ—Ä–∂–∏—Ç ${itemCount} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
				} else {
					console.error("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø inventory:", inventory);
					itemCount = 0;
				}

				// –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤
				if (itemCount === 0) {
					console.log("üì≠ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç");
					elements.inventoryList.innerHTML =
						'<div class="inventory-item">–ü—É—Å—Ç–æ</div>';
					return;
				}

				console.log(`üîÑ –î–æ–±–∞–≤–ª—è—é ${itemCount} –ø—Ä–µ–¥–º–µ—Ç(–æ–≤)...`);

				// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ —ç—Ç–æ Set
				let itemsArray;
				if (inventory instanceof Set) {
					itemsArray = Array.from(inventory);
				} else {
					itemsArray = inventory;
				}

				console.log("üìã –ü—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:", itemsArray);

				// –°–æ–∑–¥–∞–µ–º HTML
				const itemsHTML = itemsArray
					.map((item) => `<div class="inventory-item">${item}</div>`)
					.join("");

				console.log("üñ•Ô∏è  HTML –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:", itemsHTML);

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML
				elements.inventoryList.innerHTML = itemsHTML;

				console.log("‚úÖ –ò–ù–í–ï–ù–¢–ê–†–¨ –û–ë–ù–û–í–õ–ï–ù!");
				console.log(
					"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM: —Ç–µ–ø–µ—Ä—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -",
					elements.inventoryList.children.length
				);
			}

			// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞
			function registerPlayer(name, isReconnect = false) {
				const playerName = name || elements.nameInput.value.trim();

				// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
				if (!playerName) {
					logMessage("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞", "error");
					elements.nameInput.focus();
					return;
				}

				if (
					playerName.length < CONFIG.PLAYER_NAME_MIN ||
					playerName.length > CONFIG.PLAYER_NAME_MAX
				) {
					logMessage(
						`–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç ${CONFIG.PLAYER_NAME_MIN} –¥–æ ${CONFIG.PLAYER_NAME_MAX} —Å–∏–º–≤–æ–ª–æ–≤`,
						"error"
					);
					return;
				}

				if (!isReconnect) {
					AppState.playerName = playerName;
					logMessage(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ "${playerName}"...`, "system");
				}

				// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
				sendWebSocketMessage({
					type: "register",
					content: playerName,
				});
			}

			// –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
			function sendGameCommand(command) {
				if (!command) {
					command = elements.commandInput.value.trim();
					if (!command) {
						return;
					}
					elements.commandInput.value = "";
				}

				if (!AppState.registered) {
					logMessage("–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å", "error");
					return;
				}

				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã
				const trimmedCommand = command.trim();
				const isSayCommand =
					trimmedCommand.startsWith("say ") ||
					trimmedCommand.startsWith("—Å–∫–∞–∑–∞—Ç—å ") ||
					trimmedCommand.startsWith("—Å ");

				logMessage(`> ${command}`, "command");

				if (isSayCommand) {
					// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
					const message = command.replace(/^(say|—Å–∫–∞–∑–∞—Ç—å|—Å)\s+/, "");

					// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞
					sendWebSocketMessage({
						type: "chat",
						player: AppState.playerName,
						content: message,
					});
				} else {
					// –û–±—ã—á–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
					sendWebSocketMessage({
						type: "command",
						player: AppState.playerName,
						content: command,
					});
				}
			}

			// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
			function sendWebSocketMessage(message) {
				if (!AppState.ws || AppState.ws.readyState !== WebSocket.OPEN) {
					logMessage("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
					connectWebSocket();
					return false;
				}

				try {
					AppState.ws.send(JSON.stringify(message));
					return true;
				} catch (error) {
					logMessage(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error}`, "error");
					return false;
				}
			}

			// ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

			// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
			function showBrowserNotification(message) {
				if ("Notification" in window && Notification.permission === "granted") {
					new Notification("–ò–≥—Ä–∞: –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", {
						body: message,
						icon: "/favicon.ico",
					});
				}
			}

			// –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ–π beep)
			function playNotificationSound() {
				try {
					const audioContext = new (window.AudioContext ||
						window.webkitAudioContext)();
					const oscillator = audioContext.createOscillator();
					const gainNode = audioContext.createGain();

					oscillator.connect(gainNode);
					gainNode.connect(audioContext.destination);

					oscillator.frequency.value = 800;
					oscillator.type = "sine";

					gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
					gainNode.gain.exponentialRampToValueAtTime(
						0.01,
						audioContext.currentTime + 0.5
					);

					oscillator.start(audioContext.currentTime);
					oscillator.stop(audioContext.currentTime + 0.5);
				} catch (e) {
					// –ë–µ–∑ –∑–≤—É–∫–∞, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
				}
			}

			// –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
			function requestNotificationPermission() {
				if ("Notification" in window && Notification.permission === "default") {
					Notification.requestPermission().then((permission) => {
						if (permission === "granted") {
							logMessage("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã", "system");
						}
					});
				}
			}

			// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========

			function setupEventListeners() {
				// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
				elements.registerBtn.addEventListener("click", () => registerPlayer());
				elements.nameInput.addEventListener("keypress", function (e) {
					if (e.key === "Enter") {
						registerPlayer();
					}
				});

				// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã
				elements.sendBtn.addEventListener("click", () => sendGameCommand());
				elements.commandInput.addEventListener("keypress", function (e) {
					if (e.key === "Enter") {
						sendGameCommand();
					}
				});

				// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å
				document.addEventListener("click", function () {
					if (AppState.registered) {
						elements.commandInput.focus();
					} else {
						elements.nameInput.focus();
					}
				});

				// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
				document.addEventListener("keydown", function (e) {
					// Ctrl+L - –æ—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
					if (e.ctrlKey && e.key === "l") {
						e.preventDefault();
						elements.output.innerHTML = "";
						logMessage("–≠–∫—Ä–∞–Ω –æ—á–∏—â–µ–Ω", "system");
					}

					// Escape - –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
					if (e.key === "Escape") {
						elements.commandInput.value = "";
					}

					// –°—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–∞–Ω–¥ (–∑–∞–≥–ª—É—à–∫–∞)
					if (e.key === "ArrowUp") {
						e.preventDefault();
						elements.commandInput.value = "look";
					}
				});

				// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏
				document.addEventListener("visibilitychange", function () {
					if (document.hidden) {
						logMessage("–ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ", "system");
					}
				});
			}

			// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

			function initApp() {
				logMessage("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞...", "system");

				setupEventListeners();
				connectWebSocket();
				requestNotificationPermission();

				// –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
				elements.nameInput.focus();

				logMessage("–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.", "system");
			}

			// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
			document.addEventListener("DOMContentLoaded", initApp);
		</script>
	</body>
</html>
